<!DOCTYPE html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/css/admin.css" />
  <link rel="shortcut icon" href="/img/icons/browser_icon.ico"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Project Form - Text Machine Lab</title>
</head>

<head>
  <script>
  function toggleMenu() {
      var x = document.getElementById("navmenu");
      if (x.className === "menu-items") {
          x.className += " responsive";
      } else {
          x.className = "menu-items";
      }
  }
  </script>
</head>

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container-fluid">
    <a href="/">
      <img src="/img/icons/text-machine-White-min.png" hspace="20" class='navbar-logo'>
    </a>
    <div class="menu-items" id="navmenu">
      <div class="items-wrapper">
      <a href="/"> <span>Home</span></a>
      <a href="/projects/"><span>Projects</span></a>
      <a href="/events/"><span>Events</span></a>
      <a href="/people/"><span>People</span></a>
      <a href="/publications/"><span>Publications</span></a>
      <a href="https://text-machine-lab.github.io/blog/" target="_blank"><span>Blog<img class="blog-icon" src="/img/icons/external-link.png"></span></a>
      <a href="/contact/"><span>Contact</span></a>
      <a href="javascript:void(0);" class="icon" onclick="toggleMenu()">
          <i class="fa fa-bars"></i>
        </a>
      </div>
    </div>
  </div>
</nav>

<body>
  <div class="container dashboard-container">
    <div class="admin-form-container">
      <div class="admin-form-header">
        <h2 id="formTitle">Add New Project</h2>
        <a href="/admin/projects/" class="btn btn-default">
          <i class="fa fa-arrow-left"></i> Back to Projects
        </a>
      </div>
      
      <div id="messageArea"></div>
      
      <form id="projectForm" class="admin-form">
        <div class="form-group">
          <label for="title">Project Title *</label>
          <input type="text" class="form-control" id="title" name="title" required 
                 placeholder="Enter project title" data-label="Project Title">
        </div>
        
        <div class="form-group">
          <label for="description">Description *</label>
          <textarea class="form-control" id="description" name="description" required 
                    placeholder="Enter project description" data-label="Description"></textarea>
        </div>
        
        <div class="form-group">
          <label for="projectImage">Project Image</label>
          <div class="image-upload-container">
            <input type="file" class="form-control" id="projectImage" name="projectImage" 
                   accept="image/*" onchange="handleImageUpload(this, 'imagePreview')">
            <small class="text-muted">Upload an image for the project (JPG, PNG, GIF)</small>
            <div id="imagePreview" class="image-preview" style="margin-top: 10px;"></div>
          </div>
          <div class="form-group" style="margin-top: 15px;">
            <label for="imageUrl">Or Image URL</label>
            <input type="url" class="form-control" id="imageUrl" name="imageUrl" 
                   placeholder="https://example.com/image.jpg">
            <small class="text-muted">Alternatively, provide a URL to an existing image</small>
          </div>
        </div>
        
        <div class="form-group">
          <label for="externalLink">External URL</label>
          <input type="url" class="form-control" id="externalLink" name="externalLink" 
                 placeholder="https://example.com/project">
          <small class="text-muted">Link to external project page or demo</small>
        </div>
        
        <div class="form-group">
          <label for="tags">Tags</label>
          <input type="text" class="form-control" id="tags" name="tags" 
                 placeholder="Enter tags separated by commas (e.g., NLP, Machine Learning, Research)">
          <small class="text-muted">Separate multiple tags with commas</small>
        </div>
        
        <div class="form-group">
          <label for="category">Category</label>
          <select class="form-control" id="category" name="category">
            <option value="">Select a category</option>
            <option value="Research">Research</option>
            <option value="Tool">Tool</option>
            <option value="Dataset">Dataset</option>
            <option value="Publication">Publication</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-default" onclick="window.location.href='/admin/projects/'">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span id="submitBtnText">Save Project</span>
            <i id="submitSpinner" class="fa fa-spinner fa-spin" style="display: none;"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
</body>

<footer class="site-footer">
  <center><a href="https://www.uml.edu/" target="_blank">
    <img src="/img/icons/uml.png" alt="UML" height="42"></center></a>
  <div class="container">
    <p class="powered-by">
      &copy Text Machine Lab. Powered by Hugo.
    </p>
  </div>
</footer>

<script src="/js/auth.js"></script>
<script src="/js/api.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/imageStorage.js"></script>
<script>
let isEditMode = false;
let projectId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    Auth.requireAuth();
    
    // Check if editing existing project
    projectId = Utils.getUrlParam('id');
    if (projectId) {
        isEditMode = true;
        document.getElementById('formTitle').textContent = 'Edit Project';
        document.getElementById('submitBtnText').textContent = 'Update Project';
        loadProject(projectId);
    }
    
    // Setup form submission
    const projectForm = document.getElementById('projectForm');
    projectForm.addEventListener('submit', handleFormSubmit);
});

async function loadProject(id) {
    const messageArea = document.getElementById('messageArea');
    
    try {
        const project = await API.projects.getById(id);
        
        // Populate form with project data
        Utils.populateForm(document.getElementById('projectForm'), {
            title: project.title,
            description: project.description,
            imageUrl: project.imageUrl,
            externalLink: project.externalLink,
            tags: Array.isArray(project.tags) ? project.tags.join(', ') : project.tags,
            category: project.category
        });
        
    } catch (error) {
        console.error('Error loading project:', error);
        Utils.showError(messageArea, 'Failed to load project: ' + error.message);
    }
}

// Handle image upload and preview
function handleImageUpload(input, previewId) {
    const file = input.files[0];
    const preview = document.getElementById(previewId);
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid #ddd;">
                <p><small>Selected: ${file.name}</small></p>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '';
    }
}

// Convert image to base64 for storage
async function processImageUpload(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    const messageArea = document.getElementById('messageArea');
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const submitSpinner = document.getElementById('submitSpinner');
    
    // Clear previous messages
    Utils.clearMessage(messageArea);
    
    // Validate form
    const validation = Utils.validateForm(e.target);
    if (!validation.isValid) {
        Utils.showError(messageArea, validation.errors.join('<br>'));
        return;
    }
    
    // Get form data
    const formData = Utils.formToObject(e.target);
    
    // Process image upload
    const imageFile = document.getElementById('projectImage').files[0];
    if (imageFile) {
        try {
            // Upload image to backend
            const uploadResponse = await API.projects.uploadImage(imageFile);
            formData.imageUrl = `http://localhost:8082${uploadResponse.url}`;
        } catch (error) {
            Utils.showError(messageArea, 'Error uploading image: ' + error.message);
            return;
        }
    }
    
    // Process tags - convert to Tag objects with name and displayName
    if (formData.tags) {
        formData.tags = formData.tags.split(',')
            .map(tag => tag.trim())
            .filter(tag => tag)
            .map(tag => ({ 
                name: tag.toLowerCase().replace(/\s+/g, '-'), 
                displayName: tag 
            }));
    } else {
        formData.tags = [];
    }
    
    // Process category - convert to Category object with name and displayName
    if (formData.category) {
        formData.categories = [{ 
            name: formData.category.toLowerCase().replace(/\s+/g, '-'), 
            displayName: formData.category 
        }];
        delete formData.category; // Remove the string category field
    } else {
        formData.categories = [];
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtnText.style.display = 'none';
    submitSpinner.style.display = 'inline';
    
    try {
        if (isEditMode) {
            // Update existing project
            await API.projects.update(projectId, formData);
            Utils.showSuccess(messageArea, 'Project updated successfully!');
        } else {
            // Create new project
            await API.projects.create(formData);
            Utils.showSuccess(messageArea, 'Project created successfully!');
        }
        
        // Redirect after success
        setTimeout(() => {
            window.location.href = '/admin/projects/';
        }, 1500);
        
    } catch (error) {
        console.error('Error saving project:', error);
        Utils.showError(messageArea, 'Failed to save project: ' + error.message);
        
        // Reset button state
        submitBtn.disabled = false;
        submitBtnText.style.display = 'inline';
        submitSpinner.style.display = 'none';
    }
}
</script>