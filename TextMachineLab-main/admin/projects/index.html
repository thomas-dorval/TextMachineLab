<!DOCTYPE html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/css/admin.css" />
  <link rel="shortcut icon" href="/img/icons/browser_icon.ico"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Manage Projects - Text Machine Lab</title>
</head>

<head>
  <script>
  function toggleMenu() {
      var x = document.getElementById("navmenu");
      if (x.className === "menu-items") {
          x.className += " responsive";
      } else {
          x.className = "menu-items";
      }
  }
  </script>
</head>

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container-fluid">
    <a href="/">
      <img src="/img/icons/text-machine-White-min.png" hspace="20" class='navbar-logo'>
    </a>
    <div class="menu-items" id="navmenu">
      <div class="items-wrapper">
      <a href="/"> <span>Home</span></a>
      <a href="/projects/"><span>Projects</span></a>
      <a href="/events/"><span>Events</span></a>
      <a href="/people/"><span>People</span></a>
      <a href="/publications/"><span>Publications</span></a>
      <a href="https://text-machine-lab.github.io/blog/" target="_blank"><span>Blog<img class="blog-icon" src="/img/icons/external-link.png"></span></a>
      <a href="/contact/"><span>Contact</span></a>
      <a href="javascript:void(0);" class="icon" onclick="toggleMenu()">
          <i class="fa fa-bars"></i>
        </a>
      </div>
    </div>
  </div>
</nav>

<body>
  <div class="container dashboard-container">
    <div class="dashboard-header">
      <h1>Manage Projects</h1>
      <div class="user-info">
        <a href="/admin/" class="btn btn-default">
          <i class="fa fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </div>
    
    <div id="messageArea"></div>
    
    <div class="admin-table-container">
      <div class="admin-table-header">
        <h2>Projects</h2>
        <div class="admin-table-actions">
          <input type="text" class="form-control" id="searchInput" placeholder="Search projects..." style="width: 200px; display: inline-block;">
          <a href="/admin/projects/form.html" class="btn btn-primary">
            <i class="fa fa-plus"></i> Add New Project
          </a>
        </div>
      </div>
      
      <div id="projectsTableContainer">
        <div class="text-center" style="padding: 40px;">
          <i class="fa fa-spinner fa-spin fa-2x"></i>
          <p>Loading projects...</p>
        </div>
      </div>
    </div>
  </div>
</body>

<footer class="site-footer">
  <center><a href="https://www.uml.edu/" target="_blank">
    <img src="/img/icons/uml.png" alt="UML" height="42"></center></a>
  <div class="container">
    <p class="powered-by">
      &copy Text Machine Lab. Powered by Hugo.
    </p>
  </div>
</footer>

<script src="/js/auth.js"></script>
<script src="/js/api.js"></script>
<script src="/js/utils.js"></script>
<script>
let allProjects = [];
let filteredProjects = [];

document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    Auth.requireAuth();
    
    // Load projects
    loadProjects();
    
    // Setup search
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', Utils.debounce(handleSearch, 300));
});

async function loadProjects() {
    const messageArea = document.getElementById('messageArea');
    const container = document.getElementById('projectsTableContainer');
    
    try {
        Utils.showLoading(container);
        
        const projects = await API.projects.getAll();
        allProjects = projects;
        filteredProjects = projects;
        
        renderProjectsTable();
        
    } catch (error) {
        console.error('Error loading projects:', error);
        Utils.showError(container, 'Failed to load projects: ' + error.message);
    }
}

function renderProjectsTable() {
    const container = document.getElementById('projectsTableContainer');
    
    if (filteredProjects.length === 0) {
        container.innerHTML = `
            <div class="text-center" style="padding: 40px;">
                <i class="fa fa-folder-open fa-3x text-muted"></i>
                <h3>No projects found</h3>
                <p class="text-muted">Get started by adding your first project.</p>
                <a href="/admin/projects/form.html" class="btn btn-primary">
                    <i class="fa fa-plus"></i> Add New Project
                </a>
            </div>
        `;
        return;
    }
    
    let tableHtml = `
        <table class="table admin-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Tags</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    filteredProjects.forEach(project => {
        const tags = Array.isArray(project.tags) ? project.tags.join(', ') : (project.tags || '');
        const description = project.description ? 
            (project.description.length > 100 ? project.description.substring(0, 100) + '...' : project.description) : 
            'No description';
        
        tableHtml += `
            <tr>
                <td>
                    <strong>${Utils.sanitizeHtml(project.title || 'Untitled')}</strong>
                    ${project.externalUrl ? `<br><small><a href="${project.externalUrl}" target="_blank"><i class="fa fa-external-link"></i> View</a></small>` : ''}
                </td>
                <td class="text-truncate" style="max-width: 300px;">${Utils.sanitizeHtml(description)}</td>
                <td><small>${Utils.sanitizeHtml(tags)}</small></td>
                <td><small>${Utils.formatDate(project.createdAt)}</small></td>
                <td class="actions">
                    <a href="/admin/projects/form.html?id=${project.id}" class="btn btn-sm btn-default">
                        <i class="fa fa-edit"></i> Edit
                    </a>
                    <button class="btn btn-sm btn-danger" onclick="deleteProject(${project.id})">
                        <i class="fa fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    tableHtml += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = tableHtml;
}

function handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    if (!searchTerm) {
        filteredProjects = allProjects;
    } else {
        filteredProjects = allProjects.filter(project => 
            (project.title && project.title.toLowerCase().includes(searchTerm)) ||
            (project.description && project.description.toLowerCase().includes(searchTerm)) ||
            (project.tags && project.tags.some && project.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
        );
    }
    
    renderProjectsTable();
}

async function deleteProject(projectId) {
    if (!Utils.confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        return;
    }
    
    const messageArea = document.getElementById('messageArea');
    
    try {
        await API.projects.delete(projectId);
        
        Utils.showSuccess(messageArea, 'Project deleted successfully');
        
        // Remove from local arrays
        allProjects = allProjects.filter(p => p.id !== projectId);
        filteredProjects = filteredProjects.filter(p => p.id !== projectId);
        
        // Re-render table
        renderProjectsTable();
        
        // Clear message after 3 seconds
        setTimeout(() => Utils.clearMessage(messageArea), 3000);
        
    } catch (error) {
        console.error('Error deleting project:', error);
        Utils.showError(messageArea, 'Failed to delete project: ' + error.message);
    }
}
</script>